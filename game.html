<html>
    <head>
        <title>RPG GAME</title>
        <link rel="icon" href="panorama/icon.png">
        <script src="utility.js" type="text/javascript"></script>
        <script src="jquery-3.2.1.js" type="text/javascript"></script>
        <script src="canvas.js" type="text/javascript"></script>
        <script src="maps.js" type="text/javascript"></script>
        <script src="animate.js" type="text/javascript"></script>
        <script src="spritesheet.js" type="text/javascript"></script>
        <script src="sprite.js" type="text/javascript"></script>
        <script src="world.js" type="text/javascript"></script>
        <script src="keyboard.js" type="text/javascript"></script>
        <script src="mouse.js" type="text/javascript"></script>
        <script src="point.js" type="text/javascript"></script>
        <script src="vector.js" type="text/javascript"></script>
        <script src="segment.js" type="text/javascript"></script>
        <script src="rectangle.js" type="text/javascript"></script>
        
        <script language = "javascript">
            
            var Context = null;
            var framerate = 24;
            
            var canvasWidth = 480;
            var canvasHeight = 360;
            
            var rel_x = 4;
            var rel_y = 0;
            
            var char_x = 16;
            var char_y = 16;
            
            var speed = 2;
                     
            var sprite_width = 24;
            var sprite_height = 32;
            
            var stone = new Sprite("ChipSet/stone.png", 16, 16, 1, 1);
            var grass = new Sprite("ChipSet/grass.png", 16, 16, 1, 1);            
            var bergwald = new Sprite("ChipSet/bergwald.png", 16, 16, 30, 16);
            
            var panorama = new Sprite("Panorama/AngrySheeps.jpg", 320, 240, 1, 1);
            
            var character = new Sprite("CharSet/character.png", 24, 32, 8, 12);
            var character_is_moving = false;
            var character_direction = 0;
            var character_look = 0;
            var move_character_enabled = true;
            
            var audio1 = new Audio('Music/banana-phone.ogg');
            var audio2 = new Audio('Music/forest.ogg');
            
            var mouse_x = 0;
            var mouse_y = 0;
            
            $(document).ready(function() {
                
                Context = new HTML("game", canvasWidth, canvasHeight);
                
                // Easy access to grafics (gfx)
                window.gfx = Context.context;
                
                InitializeKeyboard();
                
                InitalizeAnimationCounters();
                
                InitalizeMouse();
            });
            
            $(window).on('load', function () {});
            
            setInterval(function() {
                // Background: TODO: Implement moving background
                // Stretch panorama to canavas size for a background
                panorama.draw2(0, 0, canvasWidth, canvasHeight);
                
                var char_collision_box = new Rectangle(char_x, char_y, sprite_width, sprite_height);
                
                ResetAnimationCounter();
                
                // Draw Map from a single spritesheet + indexMap 
                var bMapIndex = 0;        
                for (var h = 0; h < 22; h++) {
                    for (var w = 0; w < 22; w++, bMapIndex++) {
                        var tile_w = (w + rel_x) * 16;
                        var tile_h = (h + rel_y) * 16;
                        bergwald.draw(tile_w, tile_h, map[bMapIndex]-1);
                    }
                }
                
                var rect1 = new Rectangle(100, 100, 10, 10);
                rect1.draw('blue', true, 'blue',false);
                
                if (char_collision_box.rectInside(rect1)) {
                    rect1.draw('red',true,'red',false);
                    audio1.play();
                }
                else
                    audio1.pause();
                
                var rect2 = new Rectangle(200, 100, 10, 10);
                rect2.draw('green',true,'green',false);
                
                if (char_collision_box.rectInside(rect2)) {
                    rect2.draw('yellow',true,'yellow',false);
                    audio2.play();
                }
                else
                    audio2.pause();
                
                
                var mouseRect = new Rectangle(mouse_x, mouse_y, sprite_width, sprite_height);
                mouseRect.draw('white', false, 'black',true);
                
                character_is_moving = false;
                
                character_direction = 0;
                
                // Pseudo gravity
                if (char_x < 44) {
                    move_character_enabled = false;
                    if (char_y < 320)
                        char_y = char_y + 4;
                    else 
                        move_character_enabled = true;
                }                    
                else if (char_x > 410) {
                    move_character_enabled = false;
                    if (char_y < 320)
                        char_y = char_y + 4;
                    else
                        move_character_enabled = true;
                }
                else if (char_y < 40) {
                    move_character_enabled = false;
                    char_y = char_y + 4;                   
                }
                else move_character_enabled = true;
                
                // INPUT
                
                // Teleport to mouse                
                if (key.enter) {
                    char_x = mouse_x;
                    char_y = mouse_y;
                }
                
                if (key.esc) {
                    EnableScrollbar();
                }
                
                // <if else> for four direction movement
                if (move_character_enabled) {
                    if (key.up || key.w) {
                        char_y -= speed;
                        if (char_y < -16) {
                            char_y = -16;
                        }
                        character_direction |= DIR_N;
                        character_look = DIR_N;
                        character_is_moving = true;
                    }
                    if (key.down || key.s) {
                        char_y += speed;
                        if (char_y > canvasHeight-32) {
                            char_y = canvasHeight-32;
                        }
                        character_direction |= DIR_S;
                        character_look = DIR_S;
                        character_is_moving = true;
                    }
                    if (key.left || key.a) {
                        char_x -= speed;
                        if (char_x < -4) {
                            char_x = -4;
                        }
                        character_direction |= DIR_W;
                        character_look = DIR_W;
                        character_is_moving = true;
                    }
                    if (key.right || key.d) {
                        char_x += speed;
                        if (char_x > canvasWidth-20) {
                            char_x = canvasWidth-20;
                        }
                        character_direction |= DIR_E;
                        character_look = DIR_E;
                        character_is_moving = true;
                    }
                }
                
                if (key.key0) {
                    DisableScrollbar();
                }
                if (key.plus) {
                    speed++;
                    if (speed > 10) {
                        speed = 10;
                    }
                }
                if (key.minus) {
                    speed--;
                    if (speed < 1) {
                        speed = 1;
                    }
                }
                if (key.o) {
                    // Mouse position
                    console.log("mouse_x: " +mouse_x+", mouse_y" +mouse_y);
                }
                
                if (key.p) {
                    // Position debug
                    console.log("char_x: " +char_x+", char_y" +char_y);
                }                
                
                // Animated characters
                var char_seq = 0;
                var char_look = 25;
                
                if (character_is_moving)
                {
                    if (character_direction & DIR_W) char_seq = [36,37,38];
                    if (character_direction & DIR_E) char_seq = [12,13,14];     
                    if (character_direction & DIR_N) char_seq = [0,1,2];
                    if (character_direction & DIR_S) char_seq = [24,25,26];
                    
                    character.draw(char_x, char_y, char_seq);
                }
                else
                {
                    if (character_look == DIR_W) char_look = 37;
                    if (character_look == DIR_E) char_look = 13;     
                    if (character_look == DIR_N) char_look = 1;
                    if (character_look == DIR_S) char_look = 25;
                    
                    if (!move_character_enabled) char_look = 31;
                    
                    character.draw(char_x, char_y, char_look);
                } 
                
                
            }, framerate);
            
            function enterFullscreen(element) {
                if(element.requestFullscreen) {
                    element.requestFullscreen();
                } else if(element.mozRequestFullScreen) {
                    element.mozRequestFullScreen();
                } else if(element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if(element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                }
                //TODO resize canvas if fullscreen
                //canvasHeight = $(window).height();
                //canvasWidth = $(window).width();
                //Context.context.width = canvasWidth;
                //Context.context.height = canvasHeight;               
            }
        
        </script>
        
    </head>


    <body>
        <h1 id="title" >game.html</h1>
        
        <p>
            Clicking on the game disables scrolling for this website. Press "Esc" to enable it again.
            
            <button onclick="enterFullscreen(document.getElementById('game'))" id="exit">Fullscreen</button>
        </p>
        
        <p>
            WASD or Arrow-Key: Character Control; Click: Moves Character to Mouse; +/-: Speed Up/Down
        </p>
    
        <canvas id="game"></canvas>
        
    </body>    
</html>